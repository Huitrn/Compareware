# Pr√°ctica 5: Registrar intentos fallidos de acceso

## üìã Descripci√≥n
Sistema de **logging de seguridad** implementado para registrar y monitorear intentos fallidos de acceso, as√≠ como eventos de seguridad exitosos.

## üéØ Objetivos Completados

### ‚úÖ Paso 43: Guardar en un log los intentos fallidos
- **Implementaci√≥n**: Sistema de logging con archivos separados
- **Archivos de log**:
  - `logs/failed-access.log` - Intentos fallidos detallados
  - `logs/security.log` - Eventos de seguridad generales
- **Funcionalidad**: Escritura as√≠ncrona sin bloquear el servidor

### ‚úÖ Paso 44: Incluir fecha, ruta y usuario
- **Informaci√≥n registrada**:
  - ‚úÖ **Timestamp**: ISO 8601 con timezone
  - ‚úÖ **IP del cliente**: Direcci√≥n real del usuario
  - ‚úÖ **Ruta accedida**: Endpoint espec√≠fico
  - ‚úÖ **M√©todo HTTP**: GET, POST, etc.
  - ‚úÖ **Usuario**: Username extra√≠do de credenciales
  - ‚úÖ **Tipo de autenticaci√≥n**: BASIC_AUTH o JWT_TOKEN
  - ‚úÖ **Raz√≥n del fallo**: C√≥digo espec√≠fico del error
  - ‚úÖ **User-Agent**: Informaci√≥n del cliente
  - ‚úÖ **C√≥digo de estado**: HTTP status code

### ‚úÖ Paso 45: Verificar archivo de logs
- **Endpoints de verificaci√≥n**:
  - `GET /api/logs/failed-access` - Consultar intentos fallidos
  - `GET /api/logs/security` - Ver eventos de seguridad
  - `GET /api/logs/stats` - Estad√≠sticas generales
- **Pruebas realizadas**: ‚úÖ Logs funcionando correctamente

## üõ†Ô∏è Implementaci√≥n T√©cnica

### Configuraci√≥n del Sistema de Logging
```javascript
const LOG_CONFIG = {
  logDir: path.join(__dirname, 'logs'),
  failedAccessLog: path.join(__dirname, 'logs', 'failed-access.log'),
  securityLog: path.join(__dirname, 'logs', 'security.log'),
  maxLogSize: 10 * 1024 * 1024, // 10MB m√°ximo
};
```

### Funciones Principales

#### 1. Registro de Intentos Fallidos
```javascript
const logFailedAccess = (details) => {
  // Registra: IP, m√©todo, ruta, tipo auth, usuario, raz√≥n, status
};
```

#### 2. Registro de Eventos de Seguridad
```javascript
const logSecurityEvent = (type, details) => {
  // Registra eventos exitosos y otros eventos de seguridad
};
```

### Tipos de Intentos Fallidos Registrados

#### Autenticaci√≥n B√°sica
- ‚ùå `NO_AUTH_HEADER` - Sin header de autorizaci√≥n
- ‚ùå `INVALID_BASE64_ENCODING` - Credenciales mal codificadas
- ‚ùå `INVALID_CREDENTIALS` - Usuario/contrase√±a incorrectos

#### JWT Token
- ‚ùå `NO_BEARER_TOKEN` - Sin token Bearer
- ‚ùå `EMPTY_TOKEN` - Token vac√≠o
- ‚ùå `EXPIRED_TOKEN` - Token expirado
- ‚ùå `MALFORMED_TOKEN` - Token malformado
- ‚ùå `INVALID_TOKEN` - Token inv√°lido

## üìä Endpoints de Monitoreo

### 1. Consultar Intentos Fallidos
```http
GET /api/logs/failed-access?limit=50
```

**Respuesta de ejemplo**:
```json
{
  "status": "success",
  "message": "Logs de intentos fallidos",
  "logs": [
    {
      "id": 1,
      "timestamp": "2025-10-01T02:56:15.019Z",
      "message": "FAILED_ACCESS | IP: ::1 | METHOD: GET | ROUTE: /api/admin/dashboard | AUTH_TYPE: BASIC_AUTH | USERNAME: admin | REASON: INVALID_CREDENTIALS | STATUS: 401 | USER_AGENT: Mozilla/5.0...",
      "parsed": {
        "type": "FAILED_ACCESS",
        "ip": "::1",
        "method": "GET",
        "route": "/api/admin/dashboard",
        "authtype": "BASIC_AUTH",
        "username": "admin",
        "reason": "INVALID_CREDENTIALS",
        "status": "401"
      }
    }
  ],
  "count": 3,
  "totalLines": 3,
  "logFile": "D:\\Repositorio\\Bdd Compareware\\JavaS\\api-node\\logs\\failed-access.log"
}
```

### 2. Consultar Eventos de Seguridad
```http
GET /api/logs/security?limit=50
```

### 3. Estad√≠sticas de Logs
```http
GET /api/logs/stats
```

**Respuesta de ejemplo**:
```json
{
  "status": "success",
  "message": "Estad√≠sticas de logs",
  "timestamp": "2025-10-01T02:56:41.661Z",
  "stats": {
    "failedAccess": {
      "exists": true,
      "lines": 3,
      "size": 1024,
      "lastModified": "2025-10-01T02:56:26.377Z",
      "file": "...\\logs\\failed-access.log"
    },
    "security": {
      "exists": true,
      "lines": 4,
      "size": 890,
      "lastModified": "2025-10-01T02:56:53.779Z",
      "file": "...\\logs\\security.log"
    },
    "logDirectory": "...\\logs"
  }
}
```

## üîç Estructura de Logs

### Archivo: `failed-access.log`
```
[2025-10-01T02:56:15.019Z] FAILED_ACCESS | IP: ::1 | METHOD: GET | ROUTE: /api/admin/dashboard | AUTH_TYPE: BASIC_AUTH | USERNAME: admin | REASON: INVALID_CREDENTIALS | STATUS: 401 | USER_AGENT: Mozilla/5.0 (Windows NT; Windows NT 10.0; es-MX) WindowsPowerShell/5.1.26100.6584
[2025-10-01T02:56:20.844Z] FAILED_ACCESS | IP: ::1 | METHOD: GET | ROUTE: /api/admin/dashboard | AUTH_TYPE: BASIC_AUTH | USERNAME: N/A | REASON: NO_AUTH_HEADER | STATUS: 401 | USER_AGENT: Mozilla/5.0 (Windows NT; Windows NT 10.0; es-MX) WindowsPowerShell/5.1.26100.6584
```

### Archivo: `security.log`
```
[2025-10-01T02:56:15.020Z] SECURITY_EVENT | TYPE: FAILED_AUTH | IP: ::1 | ROUTE: /api/admin/dashboard | USER: admin | REASON: INVALID_CREDENTIALS
[2025-10-01T02:56:53.779Z] SECURITY_EVENT | TYPE: SUCCESSFUL_AUTH | IP: ::1 | ROUTE: /api/admin/dashboard | MESSAGE: Autenticaci√≥n b√°sica exitosa para usuario: admin | DATA: {"authType":"BASIC_AUTH","username":"admin"}
```

## üß™ Pruebas Realizadas

### ‚úÖ Escenario 1: Credenciales Incorrectas (Basic Auth)
- **Petici√≥n**: `GET /api/admin/dashboard` con `admin:wrong_password`
- **Resultado**: ‚ùå HTTP 401 + Log registrado
- **Log**: `INVALID_CREDENTIALS` con usuario `admin`

### ‚úÖ Escenario 2: Sin Header de Autorizaci√≥n
- **Petici√≥n**: `GET /api/admin/dashboard` sin headers
- **Resultado**: ‚ùå HTTP 401 + Log registrado
- **Log**: `NO_AUTH_HEADER` con usuario `N/A`

### ‚úÖ Escenario 3: JWT Token Malformado
- **Petici√≥n**: `GET /api/jwt/protected` con token inv√°lido
- **Resultado**: ‚ùå HTTP 401 + Log registrado
- **Log**: `MALFORMED_TOKEN` con JWT_TOKEN

### ‚úÖ Escenario 4: Autenticaci√≥n Exitosa
- **Petici√≥n**: `GET /api/admin/dashboard` con credenciales correctas
- **Resultado**: ‚úÖ Log de √©xito registrado
- **Log**: `SUCCESSFUL_AUTH` en security.log

## üîí Caracter√≠sticas de Seguridad

### Informaci√≥n Completa de Auditor√≠a
- **Trazabilidad**: Cada intento incluye IP, timestamp y contexto completo
- **Forense**: Logs estructurados para an√°lisis posterior
- **Correlaci√≥n**: Logs separados pero correlacionables por IP/timestamp

### Prevenci√≥n de Ataques
- **Detecci√≥n de patrones**: M√∫ltiples intentos desde misma IP
- **An√°lisis de comportamiento**: User-Agent y patrones de acceso
- **Alertas tempranas**: Logs en tiempo real para monitoreo

### Gesti√≥n de Archivos
- **Auto-creaci√≥n**: Directorio y archivos se crean autom√°ticamente
- **Escritura as√≠ncrona**: No bloquea el servidor
- **Limpieza**: Preparado para rotaci√≥n de logs (futuro)

## üìÅ Archivos Creados/Modificados

### ‚úÖ Nuevos Archivos de Log
- `JavaS/api-node/logs/failed-access.log` - Intentos fallidos detallados
- `JavaS/api-node/logs/security.log` - Eventos de seguridad generales

### ‚úÖ C√≥digo Modificado
- `JavaS/api-node/app.js` - Sistema de logging completo implementado

## üöÄ Estado del Servidor

**‚úÖ Servidor corriendo**: `http://localhost:4000`
**‚úÖ Logs activos**: Registrando todos los intentos
**‚úÖ Endpoints funcionando**: Verificaci√≥n completada

## üìù Eventos Registrados en Pruebas

| Timestamp | Tipo | IP | Ruta | Usuario | Estado |
|-----------|------|----|----- |---------|--------|
| 02:56:15.019Z | FAILED_ACCESS | ::1 | /api/admin/dashboard | admin | ‚ùå INVALID_CREDENTIALS |
| 02:56:20.844Z | FAILED_ACCESS | ::1 | /api/admin/dashboard | N/A | ‚ùå NO_AUTH_HEADER |
| 02:56:26.377Z | FAILED_ACCESS | ::1 | /api/jwt/protected | N/A | ‚ùå MALFORMED_TOKEN |
| 02:56:53.779Z | SUCCESSFUL_AUTH | ::1 | /api/admin/dashboard | admin | ‚úÖ BASIC_AUTH_SUCCESS |

---

**‚úÖ Pr√°ctica 5 Completada** - Sistema de logging de seguridad implementado correctamente con registro completo de intentos fallidos y eventos de seguridad.