#  Validaci√≥n de Token JWT - Compareware API

##  Descripci√≥n de la Pr√°ctica

Esta implementaci√≥n cumple con los requisitos de la **Pr√°ctica 3: Agregar validaci√≥n de token**.

### Pasos Implementados:

37. **Configurar middleware que revise un token en headers** ‚úì
38. **Si el token es v√°lido, permitir acceso** ‚úì  
39. **Si no, responder con 401** ‚úì

## üîß Configuraci√≥n JWT

### Variables de Entorno (archivo .env):
```env
JWT_SECRET=13246587cba           # Clave secreta para firmar/verificar tokens
JWT_REFRESH_SECRET=13246587acb   # Clave para refresh tokens
```

## üõ°Ô∏è Middleware de Validaci√≥n JWT

El middleware `verifyToken` implementa:
- Validaci√≥n del header `Authorization: Bearer <token>`
- Verificaci√≥n del token usando `JWT_SECRET`
- Decodificaci√≥n de informaci√≥n del usuario
- Manejo de tokens expirados/malformados
- Respuestas 401 apropiadas

## Rutas Protegidas con JWT

### 1. **Perfil de Usuario**
- **URL**: `GET http://localhost:4000/api/jwt/profile`
- **Protecci√≥n**: Requiere token JWT v√°lido
- **Funcionalidad**: Obtiene informaci√≥n del usuario autenticado

### 2. **Ruta Protegida Simple**  
- **URL**: `GET http://localhost:4000/api/jwt/protected`
- **Protecci√≥n**: Requiere token JWT v√°lido
- **Funcionalidad**: Respuesta simple de confirmaci√≥n

### 3. **Generar Token de Prueba**
- **URL**: `POST http://localhost:4000/api/generate-token`
- **Protecci√≥n**: Ninguna (para obtener tokens)
- **Funcionalidad**: Genera un token JWT para testing

##  Pruebas en Postman

### **PASO 1: Generar un Token de Prueba**

**Request:**
```
POST http://localhost:4000/api/generate-token
Content-Type: application/json

Body (raw JSON):
{
  "email": "test@ejemplo.com",
  "password": "123456"
}
```

**Response Esperada:**
```json
Status: 200 OK
{
  "message": "Token generado exitosamente",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 1,
    "name": "Usuario Test",
    "email": "test@ejemplo.com"
  },
  "expiresIn": "1 hora"
}
```

### **CASO 1: Sin Token (Acceso Denegado)**

**Request:**
```
GET http://localhost:4000/api/jwt/protected
Headers: (sin Authorization)
```

**Response Esperada:**
```json
Status: 401 Unauthorized
{
  "error": "Token requerido",
  "message": "Se requiere un token de autorizaci√≥n en el header (Bearer token)"
}
```

### **CASO 2: Token Inv√°lido (Acceso Denegado)**

**Request:**
```
GET http://localhost:4000/api/jwt/protected
Authorization: Bearer token_falso_invalido
```

**Response Esperada:**
```json
Status: 401 Unauthorized
{
  "error": "Acceso denegado",
  "message": "Token malformado",
  "details": "jwt malformed"
}
```

### **CASO 3: Token V√°lido (Acceso Concedido)**

**Request:**
```
GET http://localhost:4000/api/jwt/protected
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**Response Esperada:**
```json
Status: 200 OK
{
  "message": "Acceso concedido - Token JWT v√°lido",
  "user": {
    "id": 1,
    "email": "test@ejemplo.com",
    "name": "Usuario Test",
    "iat": 1696123456,
    "exp": 1696127056
  },
  "timestamp": "2024-XX-XXTXX:XX:XX.XXXZ",
  "status": "success"
}
```

## Instrucciones Detalladas de Postman

### **Configurar Token JWT:**

1. **Generar Token**:
   - POST `http://localhost:4000/api/generate-token`
   - Body ‚Üí raw ‚Üí JSON: `{"email": "test@ejemplo.com", "password": "123456"}`
   - Copiar el `token` de la respuesta

2. **Usar Token en Rutas Protegidas**:
   - GET `http://localhost:4000/api/jwt/protected`
   - **Authorization** ‚Üí Type: **Bearer Token**
   - **Token**: Pegar el token copiado
   - Send

### **Probar Sin Token:**

1. **Misma URL**: `GET http://localhost:4000/api/jwt/protected`
2. **Authorization Type**: "No Auth"  
3. **Send** ‚Üí Deber√≠a devolver 401

### **Probar Token Inv√°lido:**

1. **Misma URL**: `GET http://localhost:4000/api/jwt/protected`
2. **Authorization Type**: "Bearer Token"
3. **Token**: `token_falso_123`
4. **Send** ‚Üí Deber√≠a devolver 401

## Funcionamiento T√©cnico

1. **Cliente env√≠a request** con header `Authorization: Bearer <token>`
2. **Middleware verifyToken** intercepta la request
3. **Extrae el token** del header Authorization
4. **Verifica el token** usando `jwt.verify()` y `JWT_SECRET`
5. **Si es v√°lido**: Decodifica info del usuario ‚Üí `req.user` ‚Üí `next()`
6. **Si es inv√°lido**: Respuesta 401 con detalles del error

##  Flujo de Validaci√≥n

```
Request ‚Üí verifyToken Middleware ‚Üí Verificar Header ‚Üí Extraer Token ‚Üí 
jwt.verify(token, JWT_SECRET) ‚Üí ¬øV√°lido? ‚Üí 
‚îú‚îÄ S√ç: req.user = decoded ‚Üí next() ‚Üí Ruta protegida
‚îî‚îÄ NO: res.status(401) ‚Üí Error espec√≠fico
```

## Comandos para Probar

```bash
# Iniciar el servidor (si no est√° corriendo)
cd "d:\Repositorio\Bdd Compareware\JavaS\api-node"
node app.js

# Probar con curl (obtener token)
curl -X POST http://localhost:4000/api/generate-token \
  -H "Content-Type: application/json" \
  -d '{"email":"test@ejemplo.com","password":"123456"}'

# Probar con curl (usar token)
curl -H "Authorization: Bearer <TOKEN_AQUI>" \
  http://localhost:4000/api/jwt/protected
```

## üéØ Resultados de la Pr√°ctica

**Paso 37**: Middleware configurado para revisar token en headers `Authorization: Bearer`
**Paso 38**: Tokens v√°lidos permiten acceso y decodifican informaci√≥n del usuario
**Paso 39**: Tokens inv√°lidos/faltantes responden con 401 y mensaje espec√≠fico

## Comparaci√≥n: Autenticaci√≥n B√°sica vs JWT

| Aspecto | Basic Auth | JWT Token |
|---------|------------|-----------|
| **Header** | `Authorization: Basic <base64>` | `Authorization: Bearer <token>` |
| **Validaci√≥n** | Usuario:contrase√±a fijos | Token firmado + secreto |
| **Informaci√≥n** | Solo credenciales | Datos del usuario + expiraci√≥n |
| **Seguridad** | B√°sica | Avanzada con firma criptogr√°fica |
| **Uso** | APIs simples | Aplicaciones modernas |

---

**Validaci√≥n de Token JWT implementada exitosamente en Compareware API**