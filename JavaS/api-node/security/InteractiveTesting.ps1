# üéØ Script Interactivo de Testing Manual SQL Injection - Windows PowerShell
# Proyecto: Compareware - Desarrollo Backend

# Configuraci√≥n
$BaseURL = "http://localhost:3000"
$LogFile = "manual_test_results_$(Get-Date -Format 'yyyyMMdd_HHmmss').log"

# Funci√≥n para mostrar banner
function Show-Banner {
    Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
    Write-Host "‚ïë                    üõ°Ô∏è  COMPAREWARE SQL INJECTION                 ‚ïë" -ForegroundColor Cyan  
    Write-Host "‚ïë                        MANUAL TESTING SUITE                     ‚ïë" -ForegroundColor Cyan
    Write-Host "‚ïë                                                                  ‚ïë" -ForegroundColor Cyan
    Write-Host "‚ïë  ‚ö†Ô∏è  SOLO PARA TESTING DE TU PROPIO SISTEMA - USO EDUCATIVO     ‚ïë" -ForegroundColor Yellow
    Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Cyan
    Write-Host ""
}

# Funci√≥n para logging
function Write-TestLog {
    param(
        [string]$Message,
        [string]$Color = "White"
    )
    
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logEntry = "[$timestamp] $Message"
    
    Add-Content -Path $LogFile -Value $logEntry
    Write-Host $Message -ForegroundColor $Color
}

# Funci√≥n de testing principal
function Test-SQLPayload {
    param(
        [string]$Description,
        [string]$URL,
        [string]$Method = "GET",
        [string]$Body = "",
        [string]$Expected = "blocked"
    )
    
    Write-Host "`nüß™ Testing: $Description" -ForegroundColor Blue
    Write-Host "URL: $URL" -ForegroundColor Magenta
    
    try {
        $stopwatch = [System.Diagnostics.Stopwatch]::StartNew()
        
        if ($Method -eq "GET") {
            $response = Invoke-WebRequest -Uri $URL -Method GET -TimeoutSec 10 -ErrorAction SilentlyContinue
        } else {
            $headers = @{"Content-Type" = "application/json"}
            $response = Invoke-WebRequest -Uri $URL -Method $Method -Body $Body -Headers $headers -TimeoutSec 10 -ErrorAction SilentlyContinue
        }
        
        $stopwatch.Stop()
        $timeElapsed = $stopwatch.ElapsedMilliseconds
        
        # An√°lisis de la respuesta
        $statusCode = $response.StatusCode
        $responseBody = $response.Content
        
        if ($statusCode -eq 403 -or $responseBody -match "blocked|ACCESS_DENIED|security") {
            Write-TestLog "‚úÖ BLOCKED - $Description (HTTP: $statusCode, Time: ${timeElapsed}ms)" "Green"
            return $true
        }
        elseif ($statusCode -eq 200) {
            if ($responseBody -match "mysql_|PostgreSQL|ORA-|SQL Server|syntax error") {
                Write-TestLog "üö® VULNERABLE! Database error exposed - $Description" "Red"
                Write-Host "Error details: $($responseBody.Substring(0, [Math]::Min(200, $responseBody.Length)))..." -ForegroundColor Red
                return $false
            }
            elseif ($responseBody -match "users|admin|database|table") {
                Write-TestLog "‚ö†Ô∏è  SUSPICIOUS RESPONSE - Possible data leakage - $Description" "Yellow" 
                return $null
            }
            else {
                Write-TestLog "‚ö†Ô∏è  PASSED - No obvious vulnerability signs - $Description (Time: ${timeElapsed}ms)" "Yellow"
                return $null
            }
        }
        else {
            Write-TestLog "‚ÑπÔ∏è  OTHER RESPONSE - HTTP $statusCode - $Description (Time: ${timeElapsed}ms)" "Cyan"
            return $true
        }
    }
    catch {
        if ($_.Exception.Message -match "timeout") {
            Write-TestLog "‚è±Ô∏è  TIMEOUT - Possible time-based injection - $Description" "Yellow"
            return $null
        }
        else {
            Write-TestLog "‚ùå ERROR - $($_.Exception.Message) - $Description" "Red"
            return $true
        }
    }
}

# Verificar servidor
function Test-ServerConnection {
    Write-Host "üîç Verificando conexi√≥n al servidor..." -ForegroundColor Blue
    
    try {
        $response = Invoke-WebRequest -Uri $BaseURL -TimeoutSec 5 -ErrorAction Stop
        Write-Host "‚úÖ Servidor accesible en $BaseURL" -ForegroundColor Green
        return $true
    }
    catch {
        Write-Host "‚ùå Servidor no accesible en $BaseURL" -ForegroundColor Red
        Write-Host "Por favor, inicia tu servidor primero:" -ForegroundColor Yellow
        Write-Host "  cd JavaS/api-node && npm start" -ForegroundColor Cyan
        return $false
    }
}

# Menu principal
function Show-Menu {
    Write-Host "`nüìã MENU DE TESTING" -ForegroundColor Cyan
    Write-Host "1. üéØ Test B√°sico de Vulnerabilidades"
    Write-Host "2. üîç Test de Boolean-Based Blind SQL Injection"
    Write-Host "3. üîó Test de Union-Based SQL Injection"
    Write-Host "4. ‚è±Ô∏è  Test de Time-Based Blind SQL Injection"
    Write-Host "5. üí• Test de Error-Based SQL Injection"
    Write-Host "6. üö™ Test de Authentication Bypass"
    Write-Host "7. üé≠ Test de Bypass Techniques"
    Write-Host "8. üöÄ Test Completo (Todos los anteriores)"
    Write-Host "9. üìä Ver Resultados y Estad√≠sticas"
    Write-Host "0. ‚ùå Salir"
    Write-Host ""
    $choice = Read-Host "Selecciona una opci√≥n (0-9)"
    return $choice
}

# Tests individuales
function Test-Basic {
    Write-Host "`nüéØ INICIANDO TESTS B√ÅSICOS" -ForegroundColor Yellow
    Write-Host "Estos tests verifican respuestas a caracteres SQL comunes"
    
    Test-SQLPayload "Comilla simple" "$BaseURL/api/users/1'"
    Test-SQLPayload "Punto y coma" "$BaseURL/api/users/1;"
    Test-SQLPayload "Comentario SQL" "$BaseURL/api/users/1--"
    Test-SQLPayload "Comentario de bloque" "$BaseURL/api/users/1/*"
    
    Write-Host "`n‚úÖ Tests b√°sicos completados" -ForegroundColor Green
}

function Test-BooleanBlind {
    Write-Host "`nüîç INICIANDO BOOLEAN-BASED BLIND SQL INJECTION TESTS" -ForegroundColor Yellow
    
    Test-SQLPayload "Condici√≥n TRUE (1=1)" "$BaseURL/api/users?id=1' AND 1=1--"
    Test-SQLPayload "Condici√≥n FALSE (1=2)" "$BaseURL/api/users?id=1' AND 1=2--"
    Test-SQLPayload "OR TRUE" "$BaseURL/api/users?id=1' OR 1=1--"
    Test-SQLPayload "Verificaci√≥n longitud BD" "$BaseURL/api/users?id=1' AND LENGTH(DATABASE())>5--"
    Test-SQLPayload "Extracci√≥n car√°cter" "$BaseURL/api/users?id=1' AND SUBSTRING(DATABASE(),1,1)='c'--"
    
    Write-Host "`n‚úÖ Tests boolean blind completados" -ForegroundColor Green
}

function Test-UnionBased {
    Write-Host "`nüîó INICIANDO UNION-BASED SQL INJECTION TESTS" -ForegroundColor Yellow
    
    Test-SQLPayload "UNION b√°sico" "$BaseURL/api/users?id=1' UNION SELECT 1,2,3--"
    Test-SQLPayload "UNION con NULL" "$BaseURL/api/users?id=1' UNION SELECT null,null,null--"
    Test-SQLPayload "Extraer info del sistema" "$BaseURL/api/users?id=1' UNION SELECT database(),user(),version()--"
    Test-SQLPayload "Listar tablas" "$BaseURL/api/users?id=1' UNION SELECT table_name,null,null FROM information_schema.tables--"
    
    Write-Host "`n‚úÖ Tests union-based completados" -ForegroundColor Green
}

function Test-TimeBased {
    Write-Host "`n‚è±Ô∏è  INICIANDO TIME-BASED BLIND SQL INJECTION TESTS" -ForegroundColor Yellow
    Write-Host "Nota: Cada test puede tardar hasta 5 segundos si es vulnerable" -ForegroundColor Cyan
    
    Test-SQLPayload "MySQL SLEEP" "$BaseURL/api/users?id=1' AND SLEEP(3)--"
    Test-SQLPayload "PostgreSQL SLEEP" "$BaseURL/api/users?id=1'; SELECT PG_SLEEP(3)--"
    Test-SQLPayload "SQL Server WAITFOR" "$BaseURL/api/users?id=1'; WAITFOR DELAY '00:00:03'--"
    
    Write-Host "`n‚úÖ Tests time-based completados" -ForegroundColor Green
}

function Test-ErrorBased {
    Write-Host "`nüí• INICIANDO ERROR-BASED SQL INJECTION TESTS" -ForegroundColor Yellow
    
    Test-SQLPayload "Error de sintaxis b√°sico" "$BaseURL/api/users?id=1''"
    Test-SQLPayload "MySQL EXTRACTVALUE" "$BaseURL/api/users?id=1' AND EXTRACTVALUE(1,CONCAT(0x7e,(SELECT database()),0x7e))--"
    Test-SQLPayload "PostgreSQL CAST error" "$BaseURL/api/users?id=1' AND CAST((SELECT version()) AS int)--"
    
    Write-Host "`n‚úÖ Tests error-based completados" -ForegroundColor Green
}

function Test-AuthBypass {
    Write-Host "`nüö™ INICIANDO AUTHENTICATION BYPASS TESTS" -ForegroundColor Yellow
    
    $body1 = '{"username":"admin'\''--","password":"anything"}'
    Test-SQLPayload "Admin bypass b√°sico" "$BaseURL/api/auth/login" "POST" $body1
    
    $body2 = '{"username":"admin'\'' OR 1=1--","password":""}'
    Test-SQLPayload "OR 1=1 bypass" "$BaseURL/api/auth/login" "POST" $body2
    
    $body3 = '{"username":"admin'\''/*","password":"anything"}'
    Test-SQLPayload "Comentario bypass" "$BaseURL/api/auth/login" "POST" $body3
    
    Write-Host "`n‚úÖ Tests authentication bypass completados" -ForegroundColor Green
}

function Test-BypassTechniques {
    Write-Host "`nüé≠ INICIANDO BYPASS TECHNIQUES TESTS" -ForegroundColor Yellow
    
    # URL Encoding
    Test-SQLPayload "URL Encoding" "$BaseURL/api/users?id=1%27%20OR%201%3D1--"
    
    # Comment bypass
    Test-SQLPayload "Comment bypass UNION" "$BaseURL/api/users?id=1' UN/**/ION SE/**/LECT 1,2,3--"
    
    # Case variation  
    Test-SQLPayload "Case variation" "$BaseURL/api/users?id=1' UnIoN sElEcT 1,2,3--"
    
    Write-Host "`n‚úÖ Tests bypass techniques completados" -ForegroundColor Green
}

function Test-FullSuite {
    Write-Host "`nüöÄ EJECUTANDO SUITE COMPLETA DE TESTS" -ForegroundColor Magenta
    
    Test-Basic
    Test-BooleanBlind
    Test-UnionBased
    Test-TimeBased
    Test-ErrorBased
    Test-AuthBypass
    Test-BypassTechniques
    
    Show-Statistics
}

function Show-Statistics {
    Write-Host "`nüìä ESTAD√çSTICAS DE TESTING" -ForegroundColor Cyan
    Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    
    if (Test-Path $LogFile) {
        $logContent = Get-Content $LogFile
        
        $totalTests = ($logContent | Select-String "Testing:").Count
        $blockedTests = ($logContent | Select-String "‚úÖ BLOCKED").Count
        $vulnerableTests = ($logContent | Select-String "üö® VULNERABLE").Count
        $suspiciousTests = ($logContent | Select-String "‚ö†Ô∏è").Count
        
        Write-Host "üìù Total de tests ejecutados: $totalTests" -ForegroundColor Blue
        Write-Host "üõ°Ô∏è  Tests bloqueados (seguro): $blockedTests" -ForegroundColor Green
        Write-Host "üö® Vulnerabilidades encontradas: $vulnerableTests" -ForegroundColor Red
        Write-Host "‚ö†Ô∏è  Respuestas sospechosas: $suspiciousTests" -ForegroundColor Yellow
        
        if ($totalTests -gt 0) {
            $securityScore = [Math]::Round(($blockedTests * 100) / $totalTests)
            Write-Host "üìä Score de seguridad: ${securityScore}%" -ForegroundColor Cyan
            
            switch ($securityScore) {
                {$_ -ge 90} { Write-Host "üéØ Nivel de seguridad: EXCELENTE" -ForegroundColor Green }
                {$_ -ge 70} { Write-Host "üéØ Nivel de seguridad: BUENO" -ForegroundColor Blue }
                {$_ -ge 50} { Write-Host "üéØ Nivel de seguridad: NECESITA MEJORAS" -ForegroundColor Yellow }
                default { Write-Host "üéØ Nivel de seguridad: CR√çTICO" -ForegroundColor Red }
            }
        }
        
        Write-Host "`nüìÑ Log detallado guardado en: $LogFile" -ForegroundColor Cyan
        
        Write-Host "`nüìã √öLTIMOS RESULTADOS:" -ForegroundColor Yellow
        Get-Content $LogFile | Select-Object -Last 10 | ForEach-Object { Write-Host "  $_" }
    }
    else {
        Write-Host "No se encontr√≥ archivo de log" -ForegroundColor Red
    }
}

# Funci√≥n principal
function Start-InteractiveTesting {
    Show-Banner
    
    Write-Host "Inicializando sistema de testing..." -ForegroundColor Blue
    Write-Host "Log file: $LogFile" -ForegroundColor Cyan
    
    # Verificar servidor
    if (-not (Test-ServerConnection)) {
        return
    }
    
    Write-Host "`nüí° Tip: Los resultados se guardan autom√°ticamente en $LogFile" -ForegroundColor Yellow
    
    # Loop principal
    do {
        $choice = Show-Menu
        
        switch ($choice) {
            "1" { Test-Basic }
            "2" { Test-BooleanBlind }
            "3" { Test-UnionBased }
            "4" { Test-TimeBased }
            "5" { Test-ErrorBased }
            "6" { Test-AuthBypass }
            "7" { Test-BypassTechniques }
            "8" { Test-FullSuite }
            "9" { Show-Statistics }
            "0" { 
                Write-Host "`nüëã ¬°Gracias por usar Compareware Security Testing Suite!" -ForegroundColor Green
                Write-Host "üìÑ Resultados guardados en: $LogFile" -ForegroundColor Cyan
                break
            }
            default { 
                Write-Host "‚ùå Opci√≥n inv√°lida. Por favor selecciona 0-9." -ForegroundColor Red
            }
        }
        
        if ($choice -ne "0") {
            Write-Host ""
            Read-Host "Presiona Enter para continuar"
        }
        
    } while ($choice -ne "0")
}

# Comandos r√°pidos adicionales
function Test-QuickSQLI {
    Write-Host "üöÄ QUICK SQL INJECTION TEST" -ForegroundColor Cyan
    
    # Test esencial
    $test1 = Test-SQLPayload "Boolean test" "$BaseURL/api/users?id=1' AND 1=1--"
    $test2 = Test-SQLPayload "Union test" "$BaseURL/api/users?id=1' UNION SELECT 1,2,3--"
    
    $body = '{"username":"admin'\'' OR 1=1--","password":""}'
    $test3 = Test-SQLPayload "Auth bypass test" "$BaseURL/api/auth/login" "POST" $body
    
    Write-Host "‚úÖ Quick test completed!" -ForegroundColor Green
}

# Exportar funciones para uso individual
Export-ModuleMember -Function Start-InteractiveTesting, Test-QuickSQLI

# Si se ejecuta directamente, iniciar testing interactivo
if ($MyInvocation.InvocationName -ne '.') {
    Start-InteractiveTesting
}