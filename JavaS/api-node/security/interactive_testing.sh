#!/bin/bash

# üéØ Script Interactivo de Testing Manual SQL Injection
# Proyecto: Compareware - Desarrollo Backend

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuraci√≥n
BASE_URL="http://localhost:3000"
LOGFILE="manual_test_results_$(date +%Y%m%d_%H%M%S).log"

# Banner
print_banner() {
    echo -e "${CYAN}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                    üõ°Ô∏è  COMPAREWARE SQL INJECTION                 ‚ïë"
    echo "‚ïë                        MANUAL TESTING SUITE                     ‚ïë"
    echo "‚ïë                                                                  ‚ïë"
    echo "‚ïë  ‚ö†Ô∏è  SOLO PARA TESTING DE TU PROPIO SISTEMA - USO EDUCATIVO     ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "${NC}"
}

# Log function
log_result() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOGFILE"
    echo -e "$2$1${NC}"
}

# Test function con an√°lisis detallado
test_payload() {
    local description=$1
    local url=$2
    local method=${3:-"GET"}
    local data=${4:-""}
    local expected=${5:-"blocked"}
    
    echo -e "\n${BLUE}üß™ Testing: $description${NC}"
    echo -e "${PURPLE}URL: $url${NC}"
    
    if [ "$method" = "GET" ]; then
        response=$(curl -s -w "HTTPSTATUS:%{http_code};TIME:%{time_total}" "$url")
    else
        response=$(curl -s -w "HTTPSTATUS:%{http_code};TIME:%{time_total}" \
                       -X "$method" -H "Content-Type: application/json" -d "$data" "$url")
    fi
    
    http_code=$(echo "$response" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
    time_total=$(echo "$response" | grep -o "TIME:[0-9.]*" | cut -d: -f2)
    body=$(echo "$response" | sed 's/HTTPSTATUS:[0-9]*;TIME:[0-9.]*//')
    
    # An√°lisis de la respuesta
    if [ "$http_code" = "403" ] || echo "$body" | grep -q "blocked\|ACCESS_DENIED\|security"; then
        log_result "‚úÖ BLOCKED - $description (HTTP: $http_code, Time: ${time_total}s)" "$GREEN"
        return 0
    elif [ "$http_code" = "200" ]; then
        if echo "$body" | grep -q "mysql_\|PostgreSQL\|ORA-\|SQL Server\|syntax error"; then
            log_result "üö® VULNERABLE! Database error exposed - $description" "$RED"
            echo -e "${RED}Error details: ${body:0:200}...${NC}"
            return 2
        elif echo "$body" | grep -q "users\|admin\|database\|table"; then
            log_result "‚ö†Ô∏è  SUSPICIOUS RESPONSE - Possible data leakage - $description" "$YELLOW"
            return 1
        else
            log_result "‚ö†Ô∏è  PASSED - No obvious vulnerability signs - $description (Time: ${time_total}s)" "$YELLOW"
            return 1
        fi
    else
        log_result "‚ÑπÔ∏è  OTHER RESPONSE - HTTP $http_code - $description (Time: ${time_total}s)" "$CYAN"
        return 0
    fi
}

# Verificar si el servidor est√° ejecut√°ndose
check_server() {
    echo -e "${BLUE}üîç Verificando conexi√≥n al servidor...${NC}"
    
    if curl -s --connect-timeout 5 "$BASE_URL" > /dev/null 2>&1; then
        echo -e "${GREEN}‚úÖ Servidor accesible en $BASE_URL${NC}"
        return 0
    else
        echo -e "${RED}‚ùå Servidor no accesible en $BASE_URL${NC}"
        echo -e "${YELLOW}Por favor, inicia tu servidor primero:${NC}"
        echo -e "${CYAN}  cd JavaS/api-node && npm start${NC}"
        exit 1
    fi
}

# Menu principal
show_menu() {
    echo -e "\n${CYAN}üìã MENU DE TESTING${NC}"
    echo "1. üéØ Test B√°sico de Vulnerabilidades"
    echo "2. üîç Test de Boolean-Based Blind SQL Injection"  
    echo "3. üîó Test de Union-Based SQL Injection"
    echo "4. ‚è±Ô∏è  Test de Time-Based Blind SQL Injection"
    echo "5. üí• Test de Error-Based SQL Injection"
    echo "6. üö™ Test de Authentication Bypass"
    echo "7. üé≠ Test de Bypass Techniques"
    echo "8. üöÄ Test Completo (Todos los anteriores)"
    echo "9. üìä Ver Resultados y Estad√≠sticas"
    echo "0. ‚ùå Salir"
    echo ""
    read -p "Selecciona una opci√≥n (0-9): " choice
}

# Test 1: B√°sico
test_basic() {
    echo -e "\n${YELLOW}üéØ INICIANDO TESTS B√ÅSICOS${NC}"
    echo "Estos tests verifican respuestas a caracteres SQL comunes"
    
    test_payload "Comilla simple" "$BASE_URL/api/users/1'"
    test_payload "Punto y coma" "$BASE_URL/api/users/1;"
    test_payload "Comentario SQL" "$BASE_URL/api/users/1--"
    test_payload "Comentario de bloque" "$BASE_URL/api/users/1/*"
    
    echo -e "\n${GREEN}‚úÖ Tests b√°sicos completados${NC}"
}

# Test 2: Boolean-Based Blind
test_boolean_blind() {
    echo -e "\n${YELLOW}üîç INICIANDO BOOLEAN-BASED BLIND SQL INJECTION TESTS${NC}"
    echo "Estos tests verifican si diferentes condiciones TRUE/FALSE producen respuestas diferentes"
    
    test_payload "Condici√≥n TRUE (1=1)" "$BASE_URL/api/users?id=1' AND 1=1--"
    test_payload "Condici√≥n FALSE (1=2)" "$BASE_URL/api/users?id=1' AND 1=2--"
    test_payload "OR TRUE" "$BASE_URL/api/users?id=1' OR 1=1--"
    test_payload "Verificaci√≥n longitud BD" "$BASE_URL/api/users?id=1' AND LENGTH(DATABASE())>5--"
    test_payload "Extracci√≥n car√°cter" "$BASE_URL/api/users?id=1' AND SUBSTRING(DATABASE(),1,1)='c'--"
    
    echo -e "\n${GREEN}‚úÖ Tests boolean blind completados${NC}"
}

# Test 3: Union-Based
test_union_based() {
    echo -e "\n${YELLOW}üîó INICIANDO UNION-BASED SQL INJECTION TESTS${NC}"
    echo "Estos tests intentan extraer datos usando UNION SELECT"
    
    test_payload "UNION b√°sico" "$BASE_URL/api/users?id=1' UNION SELECT 1,2,3--"
    test_payload "UNION con NULL" "$BASE_URL/api/users?id=1' UNION SELECT null,null,null--"
    test_payload "Extraer info del sistema" "$BASE_URL/api/users?id=1' UNION SELECT database(),user(),version()--"
    test_payload "Listar tablas" "$BASE_URL/api/users?id=1' UNION SELECT table_name,null,null FROM information_schema.tables--"
    test_payload "Listar columnas" "$BASE_URL/api/users?id=1' UNION SELECT column_name,data_type,null FROM information_schema.columns WHERE table_name='users'--"
    
    echo -e "\n${GREEN}‚úÖ Tests union-based completados${NC}"
}

# Test 4: Time-Based Blind
test_time_based() {
    echo -e "\n${YELLOW}‚è±Ô∏è  INICIANDO TIME-BASED BLIND SQL INJECTION TESTS${NC}"
    echo "Estos tests verifican demoras an√≥malas que indican ejecuci√≥n de c√≥digo SQL"
    
    echo -e "${CYAN}Nota: Cada test puede tardar hasta 5 segundos si es vulnerable${NC}"
    
    test_payload "MySQL SLEEP" "$BASE_URL/api/users?id=1' AND SLEEP(3)--"
    test_payload "PostgreSQL SLEEP" "$BASE_URL/api/users?id=1'; SELECT PG_SLEEP(3)--"
    test_payload "SQL Server WAITFOR" "$BASE_URL/api/users?id=1'; WAITFOR DELAY '00:00:03'--"
    test_payload "Conditional time delay" "$BASE_URL/api/users?id=1' AND IF(1=1,SLEEP(2),0)--"
    
    echo -e "\n${GREEN}‚úÖ Tests time-based completados${NC}"
}

# Test 5: Error-Based
test_error_based() {
    echo -e "\n${YELLOW}üí• INICIANDO ERROR-BASED SQL INJECTION TESTS${NC}"
    echo "Estos tests intentan provocar errores que revelen informaci√≥n"
    
    test_payload "Error de sintaxis b√°sico" "$BASE_URL/api/users?id=1''"
    test_payload "MySQL EXTRACTVALUE" "$BASE_URL/api/users?id=1' AND EXTRACTVALUE(1,CONCAT(0x7e,(SELECT database()),0x7e))--"
    test_payload "MySQL UPDATEXML" "$BASE_URL/api/users?id=1' AND UPDATEXML(1,CONCAT(0x7e,(SELECT user()),0x7e),1)--"
    test_payload "PostgreSQL CAST error" "$BASE_URL/api/users?id=1' AND CAST((SELECT version()) AS int)--"
    test_payload "Divisi√≥n por cero" "$BASE_URL/api/users?id=1' AND 1/0--"
    
    echo -e "\n${GREEN}‚úÖ Tests error-based completados${NC}"
}

# Test 6: Authentication Bypass
test_auth_bypass() {
    echo -e "\n${YELLOW}üö™ INICIANDO AUTHENTICATION BYPASS TESTS${NC}"
    echo "Estos tests intentan evadir la autenticaci√≥n usando SQL injection"
    
    test_payload "Admin bypass b√°sico" "$BASE_URL/api/auth/login" "POST" '{"username":"admin'"'"'--","password":"anything"}'
    test_payload "OR 1=1 bypass" "$BASE_URL/api/auth/login" "POST" '{"username":"admin'"'"' OR 1=1--","password":""}'
    test_payload "OR TRUE bypass" "$BASE_URL/api/auth/login" "POST" '{"username":"admin'"'"' OR '"'"'1'"'"'='"'"'1'"'"'","password":"test"}'
    test_payload "Comentario bypass" "$BASE_URL/api/auth/login" "POST" '{"username":"admin'"'"'/*","password":"anything"}'
    test_payload "Always true condition" "$BASE_URL/api/auth/login" "POST" '{"username":"anything'"'"' OR '"'"'a'"'"'='"'"'a","password":"test"}'
    
    echo -e "\n${GREEN}‚úÖ Tests authentication bypass completados${NC}"
}

# Test 7: Bypass Techniques
test_bypass_techniques() {
    echo -e "\n${YELLOW}üé≠ INICIANDO BYPASS TECHNIQUES TESTS${NC}"
    echo "Estos tests verifican t√©cnicas avanzadas para evadir filtros"
    
    # URL Encoding
    test_payload "URL Encoding" "$BASE_URL/api/users?id=1%27%20OR%201%3D1--"
    
    # Comment-based bypass
    test_payload "Comment bypass UNION" "$BASE_URL/api/users?id=1' UN/**/ION SE/**/LECT 1,2,3--"
    
    # MySQL version comments
    test_payload "MySQL version comment" "$BASE_URL/api/users?id=1' /*!UNION*/ /*!SELECT*/ 1,2,3--"
    
    # Case variation
    test_payload "Case variation" "$BASE_URL/api/users?id=1' UnIoN sElEcT 1,2,3--"
    
    # Alternative whitespace
    test_payload "Tab separators" "$BASE_URL/api/users?id=1'%09UNION%0ASELECT%091,2,3--"
    
    # Concatenation
    test_payload "String concatenation" "$BASE_URL/api/users?id=1' OR 'a'='a"
    
    echo -e "\n${GREEN}‚úÖ Tests bypass techniques completados${NC}"
}

# Test completo
run_full_test() {
    echo -e "\n${PURPLE}üöÄ EJECUTANDO SUITE COMPLETA DE TESTS${NC}"
    echo "Esto ejecutar√° todos los tests disponibles..."
    
    test_basic
    test_boolean_blind  
    test_union_based
    test_time_based
    test_error_based
    test_auth_bypass
    test_bypass_techniques
    
    show_statistics
}

# Mostrar estad√≠sticas
show_statistics() {
    echo -e "\n${CYAN}üìä ESTAD√çSTICAS DE TESTING${NC}"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    
    if [ -f "$LOGFILE" ]; then
        total_tests=$(grep -c "Testing:" "$LOGFILE" 2>/dev/null || echo "0")
        blocked_tests=$(grep -c "‚úÖ BLOCKED" "$LOGFILE" 2>/dev/null || echo "0")
        vulnerable_tests=$(grep -c "üö® VULNERABLE" "$LOGFILE" 2>/dev/null || echo "0")
        suspicious_tests=$(grep -c "‚ö†Ô∏è" "$LOGFILE" 2>/dev/null || echo "0")
        
        echo -e "üìù Total de tests ejecutados: ${BLUE}$total_tests${NC}"
        echo -e "üõ°Ô∏è  Tests bloqueados (seguro): ${GREEN}$blocked_tests${NC}"
        echo -e "üö® Vulnerabilidades encontradas: ${RED}$vulnerable_tests${NC}"
        echo -e "‚ö†Ô∏è  Respuestas sospechosas: ${YELLOW}$suspicious_tests${NC}"
        
        if [ "$total_tests" -gt 0 ]; then
            security_score=$(( (blocked_tests * 100) / total_tests ))
            echo -e "üìä Score de seguridad: ${CYAN}${security_score}%${NC}"
            
            if [ "$security_score" -ge 90 ]; then
                echo -e "üéØ Nivel de seguridad: ${GREEN}EXCELENTE${NC}"
            elif [ "$security_score" -ge 70 ]; then
                echo -e "üéØ Nivel de seguridad: ${BLUE}BUENO${NC}"
            elif [ "$security_score" -ge 50 ]; then
                echo -e "üéØ Nivel de seguridad: ${YELLOW}NECESITA MEJORAS${NC}"
            else
                echo -e "üéØ Nivel de seguridad: ${RED}CR√çTICO${NC}"
            fi
        fi
        
        echo ""
        echo -e "${CYAN}üìÑ Log detallado guardado en: $LOGFILE${NC}"
        
        # Mostrar √∫ltimos resultados
        echo -e "\n${YELLOW}üìã √öLTIMOS RESULTADOS:${NC}"
        tail -10 "$LOGFILE" 2>/dev/null | sed 's/^/  /'
        
    else
        echo -e "${RED}No se encontr√≥ archivo de log${NC}"
    fi
}

# Loop principal
main_loop() {
    while true; do
        show_menu
        
        case $choice in
            1) test_basic ;;
            2) test_boolean_blind ;;
            3) test_union_based ;;
            4) test_time_based ;;
            5) test_error_based ;;
            6) test_auth_bypass ;;
            7) test_bypass_techniques ;;
            8) run_full_test ;;
            9) show_statistics ;;
            0) 
                echo -e "\n${GREEN}üëã ¬°Gracias por usar Compareware Security Testing Suite!${NC}"
                echo -e "${CYAN}üìÑ Resultados guardados en: $LOGFILE${NC}"
                exit 0
                ;;
            *) 
                echo -e "${RED}‚ùå Opci√≥n inv√°lida. Por favor selecciona 0-9.${NC}"
                ;;
        esac
        
        echo ""
        read -p "Presiona Enter para continuar..."
    done
}

# Funci√≥n de ayuda
show_help() {
    echo -e "${CYAN}üÜò AYUDA - TESTING MANUAL SQL INJECTION${NC}"
    echo ""
    echo -e "${YELLOW}INTERPRETACI√ìN DE RESULTADOS:${NC}"
    echo -e "  ${GREEN}‚úÖ BLOCKED${NC}     - El WAF/validador bloque√≥ el ataque (SEGURO)"
    echo -e "  ${RED}üö® VULNERABLE${NC}  - Se detect√≥ una vulnerabilidad (CR√çTICO)" 
    echo -e "  ${YELLOW}‚ö†Ô∏è  SUSPICIOUS${NC}  - Respuesta an√≥mala que requiere investigaci√≥n"
    echo -e "  ${CYAN}‚ÑπÔ∏è  OTHER${NC}       - Respuesta no categorizada"
    echo ""
    echo -e "${YELLOW}QU√â HACER SI ENCUENTRAS VULNERABILIDADES:${NC}"
    echo "  1. üõë NO entres en p√°nico"
    echo "  2. üìã Documenta el hallazgo exacto"
    echo "  3. üîç Verifica que no sea un falso positivo"
    echo "  4. üõ†Ô∏è  Implementa la correcci√≥n apropiada"
    echo "  5. üß™ Re-testea para confirmar la correcci√≥n"
    echo ""
    echo -e "${YELLOW}CONSEJOS DE SEGURIDAD:${NC}"
    echo "  ‚Ä¢ Ejecuta estos tests SOLO en tu propio sistema"
    echo "  ‚Ä¢ Mant√©n logs de todos los tests"
    echo "  ‚Ä¢ Testea regularmente (al menos mensualmente)"
    echo "  ‚Ä¢ Revisa y actualiza las reglas de seguridad"
    echo ""
}

# Inicio del script
main() {
    print_banner
    
    echo -e "${BLUE}Inicializando sistema de testing...${NC}"
    echo -e "${CYAN}Log file: $LOGFILE${NC}"
    
    # Verificar servidor
    check_server
    
    # Mostrar ayuda inicial
    echo ""
    echo -e "${YELLOW}üí° Tip: Escribe 'help' en cualquier momento para ver ayuda${NC}"
    
    # Verificar si quiere ver ayuda
    echo ""
    read -p "¬øQuieres ver la gu√≠a de ayuda antes de empezar? (y/n): " show_help_choice
    if [[ $show_help_choice =~ ^[Yy]$ ]]; then
        show_help
        echo ""
        read -p "Presiona Enter para continuar al men√∫ principal..."
    fi
    
    # Loop principal
    main_loop
}

# Trap para cleanup
trap 'echo -e "\n${YELLOW}üßπ Limpiando y guardando resultados...${NC}"; exit 0' INT

# Ejecutar script
main "$@"