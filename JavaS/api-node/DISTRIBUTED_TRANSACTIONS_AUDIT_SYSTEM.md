# Sistema de Transacciones Distribuidas y Auditor√≠a - Compareware API

## üìã Resumen

Este documento describe la implementaci√≥n de un sistema avanzado de transacciones distribuidas, capa de repositorios y auditor√≠a completa para la API de Compareware. El sistema garantiza la integridad de los datos y proporciona trazabilidad completa de todas las operaciones.

## üèóÔ∏è Arquitectura Implementada

### Componentes Principales

1. **Capa de Repositorios** - Abstracci√≥n del acceso a datos
2. **Transaction Manager** - Gestor de transacciones distribuidas
3. **Sistema de Auditor√≠a** - Logging completo de operaciones
4. **Servicios de Negocio** - L√≥gica de aplicaci√≥n
5. **Controladores** - Endpoints de API

### Patr√≥n Arquitect√≥nico

```
Controllers ‚Üí Services ‚Üí Repositories ‚Üí Database
                ‚Üì
         Transaction Manager
                ‚Üì
          Audit System
```

## üîÑ Transacciones Distribuidas

### Caracter√≠sticas

- ‚úÖ **Atomicidad**: Todas las operaciones se ejecutan o ninguna
- ‚úÖ **Consistencia**: Los datos mantienen su integridad
- ‚úÖ **Aislamiento**: Las transacciones no interfieren entre s√≠
- ‚úÖ **Durabilidad**: Los cambios confirmados persisten
- ‚úÖ **Compensaci√≥n Autom√°tica**: Rollback autom√°tico en caso de error

### Flujo de Transacci√≥n Distribuida

```javascript
1. Generar ID √∫nico de transacci√≥n
2. Iniciar transacci√≥n en BD
3. Ejecutar operaciones secuencialmente:
   - Validar usuario
   - Validar stock
   - Reservar productos
   - Crear orden
   - Procesar pago
4. Si todas exitosas ‚Üí COMMIT
5. Si alguna falla ‚Üí ROLLBACK autom√°tico
6. Registrar resultado en auditor√≠a
```

### Ejemplo de Uso

```javascript
const orderService = new OrderService();

const result = await orderService.createOrderWithTransaction(
  userId, 
  orderData, 
  orderItems, 
  requestInfo
);

if (result.success) {
  console.log('Pedido creado:', result.order);
} else {
  console.log('Error revertido:', result.error);
}
```

## üìä Sistema de Repositorios

### BaseRepository

Clase base que proporciona operaciones CRUD est√°ndar con logging autom√°tico:

```javascript
class BaseRepository {
  async create(data, client = null) // Crear registro
  async findById(id, client = null) // Buscar por ID
  async update(id, data, client = null) // Actualizar
  async delete(id, client = null) // Eliminar
  async findAll(page, limit, client = null) // Listar con paginaci√≥n
  async executeQuery(query, params, client = null) // Query personalizada
}
```

### Repositorios Espec√≠ficos

#### UserRepository
- Gesti√≥n de usuarios con hash de contrase√±as
- Autenticaci√≥n y autorizaci√≥n
- Soft delete y restauraci√≥n

#### OrderRepository
- Creaci√≥n de √≥rdenes con items
- Gesti√≥n de estados
- Consultas avanzadas con joins

#### AuditLogRepository
- Registro completo de auditor√≠a
- Consultas por transacci√≥n, usuario, entidad
- Limpieza autom√°tica de logs antiguos

## üìù Sistema de Auditor√≠a y Logs

### Tipos de Logs

1. **Logs de Operaci√≥n**: Cada operaci√≥n CRUD
2. **Logs de Transacci√≥n**: Inicio, commit, rollback
3. **Logs de Seguridad**: Autenticaci√≥n, autorizaci√≥n
4. **Logs de Sistema**: Eventos del sistema

### Estructura de Log de Auditor√≠a

```javascript
{
  transaction_id: "txn_1234567890_abc123",
  user_id: 1,
  action: "ORDER_CREATED",
  entity_type: "ORDER",
  entity_id: 123,
  old_values: { status: "PENDING" },
  new_values: { status: "PROCESSING" },
  ip_address: "192.168.1.100",
  user_agent: "Mozilla/5.0...",
  operations_count: 5,
  start_time: "2025-10-20T10:30:00Z",
  end_time: "2025-10-20T10:30:02Z",
  duration_ms: 2000,
  status: "SUCCESS",
  created_at: "2025-10-20T10:30:02Z"
}
```

## üöÄ Endpoints de API

### √ìrdenes/Pedidos

| M√©todo | Endpoint | Descripci√≥n |
|--------|----------|-------------|
| POST | `/api/orders` | Crear pedido con transacci√≥n distribuida |
| GET | `/api/orders/:id/history` | Obtener pedido con historial completo |
| PUT | `/api/orders/:id/cancel` | Cancelar pedido con rollback |
| GET | `/api/orders/user/:userId` | √ìrdenes de usuario espec√≠fico |
| GET | `/api/orders/status/:status` | √ìrdenes por estado |
| GET | `/api/orders/stats/transactions` | Estad√≠sticas de transacciones |

### Auditor√≠a y Logs

| M√©todo | Endpoint | Descripci√≥n |
|--------|----------|-------------|
| GET | `/api/audit/transaction/:id` | Logs por transacci√≥n |
| GET | `/api/audit/user/:userId` | Logs por usuario |
| GET | `/api/audit/entity/:type/:id` | Logs por entidad |
| GET | `/api/audit/action/:action` | Logs por acci√≥n |
| GET | `/api/audit/stats` | Estad√≠sticas de auditor√≠a |
| DELETE | `/api/audit/cleanup` | Limpiar logs antiguos |

## üíæ Estructura de Base de Datos

### Tablas Principales

```sql
-- Productos con control de stock
products (id, name, price, stock_quantity, reserved_quantity, ...)

-- √ìrdenes principales
orders (id, user_id, total_amount, status, payment_method, ...)

-- Items de √≥rdenes
order_items (id, order_id, product_id, quantity, unit_price, ...)

-- Logs de auditor√≠a completos
audit_logs (id, transaction_id, action, entity_type, old_values, new_values, ...)

-- Transacciones activas (monitoreo)
active_transactions (id, transaction_id, status, operations_count, ...)
```

### √çndices Optimizados

- √çndices por transacci√≥n, usuario, entidad
- √çndices compuestos para consultas frecuentes
- √çndices parciales para datos activos

## üß™ Testing y Validaci√≥n

### Script de Pruebas

```bash
# Ejecutar suite completa de pruebas
node test_distributed_transactions.js --full

# Probar solo creaci√≥n de pedidos
node test_distributed_transactions.js --create-order

# Probar rollback con pedido que falla
node test_distributed_transactions.js --create-fail

# Ver estad√≠sticas
node test_distributed_transactions.js --stats
```

### Casos de Prueba

1. ‚úÖ **Pedido Exitoso**: Todas las operaciones se completan
2. ‚úÖ **Usuario Inexistente**: Rollback en validaci√≥n de usuario
3. ‚úÖ **Stock Insuficiente**: Rollback en validaci√≥n de stock
4. ‚úÖ **Pago Fallido**: Rollback en procesamiento de pago
5. ‚úÖ **Cancelaci√≥n**: Liberaci√≥n de stock reservado

## üìà Monitoreo y Estad√≠sticas

### M√©tricas Disponibles

- Transacciones por d√≠a/hora
- Tiempo promedio de transacci√≥n
- Tasa de √©xito/fallo
- Operaciones m√°s frecuentes
- Transacciones activas en tiempo real

### Alertas y Notificaciones

- Transacciones que exceden tiempo l√≠mite
- Tasas de error elevadas
- Problemas de stock
- Errores de pago frecuentes

## üõ°Ô∏è Seguridad y Control de Acceso

### Autenticaci√≥n Requerida

Todos los endpoints requieren token JWT v√°lido:

```javascript
headers: {
  'Authorization': 'Bearer <jwt_token>',
  'Content-Type': 'application/json'
}
```

### Rate Limiting

- Creaci√≥n de pedidos: 5 requests/minuto
- Cancelaci√≥n de pedidos: 3 requests/minuto
- Consultas generales: L√≠mites est√°ndar

### Validaciones

- Validaci√≥n de esquemas de entrada
- Sanitizaci√≥n de datos
- Prevenci√≥n de inyecci√≥n SQL
- Logging de intentos sospechosos

## üöÄ Instalaci√≥n y Configuraci√≥n

### 1. Ejecutar Migraci√≥n de Base de Datos

```sql
-- Ejecutar el archivo de migraci√≥n
\i database/migrations/001_distributed_transactions_audit_system.sql
```

### 2. Configurar Variables de Entorno

```env
# Base de datos
DB_HOST=localhost
DB_PORT=5432
DB_DATABASE=compareware
DB_USERNAME=postgres
DB_PASSWORD=password

# JWT
JWT_SECRET=your_jwt_secret_key

# API
PORT=3000
NODE_ENV=development
```

### 3. Instalar Dependencias

```bash
cd JavaS/api-node
npm install axios  # Para el script de pruebas
```

### 4. Iniciar el Servidor

```bash
node app.js
```

## üìö Ejemplos de Uso

### Crear Pedido con Transacci√≥n Distribuida

```javascript
const orderData = {
  user_id: 1,
  total_amount: 299.97,
  shipping_address: "123 Test Street, Test City",
  payment_method: "CREDIT_CARD"
};

const orderItems = [
  {
    product_id: 1,
    quantity: 2,
    unit_price: 129.99,
    subtotal: 259.98
  }
];

// POST /api/orders
const response = await fetch('/api/orders', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({ orderData, orderItems })
});
```

### Consultar Historial de Pedido

```javascript
// GET /api/orders/123/history
const history = await fetch('/api/orders/123/history', {
  headers: { 'Authorization': `Bearer ${token}` }
});

const { order, items, history: auditLogs } = await history.json();
```

### Obtener Estad√≠sticas

```javascript
// GET /api/orders/stats/transactions
const stats = await fetch('/api/orders/stats/transactions', {
  headers: { 'Authorization': `Bearer ${token}` }
});

const { weekly_stats, failed_transactions_last_24h } = await stats.json();
```

## üîß Mantenimiento

### Limpieza Autom√°tica de Logs

```sql
-- Limpiar logs m√°s antiguos de 90 d√≠as
SELECT clean_old_audit_logs(90);
```

### Monitoreo de Performance

```sql
-- Ver transacciones m√°s lentas
SELECT transaction_id, action, duration_ms 
FROM audit_logs 
WHERE duration_ms > 5000 
ORDER BY duration_ms DESC;
```

### Backup de Auditor√≠a

```bash
# Exportar logs de auditor√≠a
pg_dump -t audit_logs compareware > audit_backup.sql
```

## üéØ Beneficios Implementados

1. ‚úÖ **Integridad de Datos**: Transacciones ACID completas
2. ‚úÖ **Trazabilidad**: Auditor√≠a completa de todas las operaciones
3. ‚úÖ **Escalabilidad**: Patr√≥n de repositorios modular
4. ‚úÖ **Mantenibilidad**: C√≥digo organizado y documentado
5. ‚úÖ **Monitoreo**: Estad√≠sticas y m√©tricas en tiempo real
6. ‚úÖ **Seguridad**: Logging de seguridad y control de acceso
7. ‚úÖ **Recuperaci√≥n**: Rollback autom√°tico en caso de errores
8. ‚úÖ **Performance**: √çndices optimizados y consultas eficientes

## üìû Soporte y Contacto

Para dudas o problemas con el sistema:

1. Revisar los logs de auditor√≠a para diagn√≥stico
2. Ejecutar el script de pruebas para validar funcionalidad
3. Consultar las estad√≠sticas de transacciones para identificar patrones
4. Revisar la documentaci√≥n de endpoints espec√≠ficos

---

**¬°Sistema de transacciones distribuidas y auditor√≠a implementado exitosamente! üöÄ**